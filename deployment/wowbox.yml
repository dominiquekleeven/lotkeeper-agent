services:
  wowbox:
    build:
      context: ../
      dockerfile: docker/Dockerfile
    platform: linux/amd64
    environment:
      - WINEDEBUG=-all
      - DISPLAY=:99
      - LIBGL_ALWAYS_SOFTWARE=1
      - GALLIUM_DRIVER=llvmpipe
      - WINEDLLOVERRIDES=mscoree,mshtml=
      - __GL_SYNC_TO_VBLANK=0
      - MESA_NO_ERROR=1
      - MESA_GLTHREAD=true
      - __GL_THREADED_OPTIMIZATIONS=1
      - MESA_GL_VERSION_OVERRIDE=4.5
      - MESA_GLSL_VERSION_OVERRIDE=450
      - LP_NUM_THREADS=2
      - WINEESYNC=1
      - WINEFSYNC=1
      # ---- OpenAH Agent Environment Variables ----
      - AGENT_MODE=${AGENT_MODE:?must be set}
      - OAH_AGENT_TOKEN=${OAH_AGENT_TOKEN:?must be set}
      - OAH_HOST=http://host.docker.internal:8007
      # ---- WoW Environment Variables ----
      - WOW_EXE=${WOW_EXE:?must be set}
      - WOW_USERNAME=${WOW_USERNAME:?must be set}
      - WOW_PASSWORD=${WOW_PASSWORD:?must be set}
      - WOW_SERVER=${WOW_SERVER:?must be set}
      - WOW_REALM=${WOW_REALM:?must be set}
      # ---- Discord Logging Environment Variables ----
      - VNC_PASSWORD=${VNC_PASSWORD:?must be set}
      - DISCORD_WEBHOOK_URL=${DISCORD_WEBHOOK_URL:?must be set}
      - AGENT_NAME=${AGENT_NAME:?must be set}
      - AGENT_IMAGE_URL=${AGENT_IMAGE_URL:?must be set}
    labels:
    - logging=promtail
    - agent=${AGENT_NAME:?must be set}
    volumes:
      - client_data:/data:rw
      - /dev/shm:/dev/shm
    ports:
      - "5901:5900"
      - "6081:6080"
    shm_size: "1gb"
    mem_limit: "4g"
    cpus: "2"
    restart: unless-stopped
    command: /startup.sh

  promtail:
    image: grafana/promtail:2.9.8
    command: -config.file=/etc/promtail/config.yml -config.expand-env=true
    environment:
      # ---- Loki Logging Environment Variables ----
      - LOKI_URL=${LOKI_URL}
    volumes:
      - ./promtail-config.yml:/etc/promtail/config.yml:ro
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /tmp:/tmp
    restart: unless-stopped


volumes:
  client_data:
    external: true
